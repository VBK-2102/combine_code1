<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Doctor-Patient Translator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .chat-box {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .doctor {
            justify-content: flex-end;
        }
        .patient {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        .doctor .message-bubble {
            background-color: #007bff;
            color: white;
            margin-left: 10px;
        }
        .patient .message-bubble {
            background-color: #e9ecef;
            color: black;
            margin-right: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .timestamp {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        .settings-card {
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result-card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }
        .header {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        #status-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }
        .btn-microphone {
            position: relative;
        }
        .recording-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            background-color: red;
            border-radius: 50%;
            display: none;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Status Alert -->
        <div id="status-alert" class="alert alert-dismissible fade show" role="alert">
            <span id="alert-message"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="row min-vh-100">
            <div class="col-md-12">
                <div class="header text-center py-4">
                    <h1>Real-time Doctor-Patient Translator</h1>
                    <p class="lead">Break language barriers in medical consultations</p>
                </div>

                <div class="card settings-card mb-4">
                    <div class="card-body">
                        <form id="translator-form">
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="mb-3">
                                        <label for="doctor-lang-input" class="form-label">Doctor's Language:</label>
                                        <select class="form-select" id="doctor-lang-input" name="doctor_lang">
                                            <option value="English">English</option>
                                            <option value="Hindi">Hindi</option>
                                            <option value="Kannada">Kannada</option>
                                            <option value="Marathi">Marathi</option>
                                            <option value="Tamil">Tamil</option>
                                            <option value="Telugu">Telugu</option>
                                            <option value="Spanish">Spanish</option>
                                            <option value="French">French</option>
                                            <option value="Arabic">Arabic</option>
                                            <option value="Bengali">Bengali</option>
                                            <option value="Chinese">Chinese</option>
                                            <option value="German">German</option>
                                            <option value="Japanese">Japanese</option>
                                            <option value="Portuguese">Portuguese</option>
                                            <option value="Russian">Russian</option>
                                            <option value="Urdu">Urdu</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-5">
                                    <div class="mb-3">
                                        <label for="patient-lang-input" class="form-label">Patient's Language:</label>
                                        <select class="form-select" id="patient-lang-input" name="patient_lang">
                                            <option value="Hindi">Hindi</option>
                                            <option value="English">English</option>
                                            <option value="Kannada">Kannada</option>
                                            <option value="Marathi">Marathi</option>
                                            <option value="Tamil">Tamil</option>
                                            <option value="Telugu">Telugu</option>
                                            <option value="Spanish">Spanish</option>
                                            <option value="French">French</option>
                                            <option value="Arabic">Arabic</option>
                                            <option value="Bengali">Bengali</option>
                                            <option value="Chinese">Chinese</option>
                                            <option value="German">German</option>
                                            <option value="Japanese">Japanese</option>
                                            <option value="Portuguese">Portuguese</option>
                                            <option value="Russian">Russian</option>
                                            <option value="Urdu">Urdu</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" id="clear-btn" class="btn btn-secondary w-100">
                                        <i class="bi bi-trash"></i> Clear
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <button id="doctor-btn" type="button" class="btn btn-primary w-100 btn-microphone">
                                        <i class="bi bi-mic"></i> <span class="btn-label">Doctor Speaking</span>
                                        <span class="recording-indicator" id="doctor-recording"></span>
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button id="patient-btn" type="button" class="btn btn-primary w-100 btn-microphone">
                                        <i class="bi bi-mic"></i> <span class="btn-label">Patient Speaking</span>
                                        <span class="recording-indicator" id="patient-recording"></span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card result-card mb-4">
                            <div class="card-header">
                                <h3>Latest Message:</h3>
                            </div>
                            <div class="card-body chat-box" id="latest-message-container">
                                <p><em>Not yet started.</em></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card result-card mb-4">
                            <div class="card-header">
                                <h3>Conversation History:</h3>
                            </div>
                            <div class="card-body chat-box" id="conversation-history">
                                <p><em>No history yet.</em></p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-outline-primary w-100" id="download-btn" disabled>
                                    <i class="bi bi-download"></i> Download Conversation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const audioPlayer = new Audio();
        let isProcessing = false;
        let conversationHistory = [];
        
        // Status alert elements
        const statusAlert = document.getElementById('status-alert');
        const alertMessage = document.getElementById('alert-message');
        
        function showAlert(message, type = 'danger') {
            statusAlert.className = `alert alert-${type} alert-dismissible fade show`;
            alertMessage.textContent = message;
            statusAlert.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                const alert = bootstrap.Alert.getOrCreateInstance(statusAlert);
                alert.close();
            }, 5000);
        }
        
        function updateConversationUI() {
            const latestMessageContainer = document.getElementById('latest-message-container');
            const historyContainer = document.getElementById('conversation-history');
            const downloadBtn = document.getElementById('download-btn');
            
            if (conversationHistory.length > 0) {
                const latestEntry = conversationHistory[conversationHistory.length - 1];
                
                // Update latest message
                latestMessageContainer.innerHTML = `
                    <div class="chat-message ${latestEntry.speaker}">
                        <img src="${latestEntry.speaker}.jpg" class="avatar" alt="${latestEntry.speaker} Avatar">
                        <div class="message-bubble">
                            ${latestEntry.translated || latestEntry.original}
                            <div class="timestamp">${latestEntry.timestamp}</div>
                        </div>
                    </div>
                `;
                
                // Update history
                historyContainer.innerHTML = conversationHistory.map(entry => `
                    <div class="chat-message ${entry.speaker}">
                        <img src="${entry.speaker}.jpg" class="avatar" alt="${entry.speaker} Avatar">
                        <div class="message-bubble">
                            ${entry.translated || entry.original}
                            <div class="timestamp">${entry.timestamp}</div>
                        </div>
                    </div>
                `).join('');
                
                // Enable download button
                downloadBtn.disabled = false;
            } else {
                latestMessageContainer.innerHTML = '<p><em>Not yet started.</em></p>';
                historyContainer.innerHTML = '<p><em>No history yet.</em></p>';
                downloadBtn.disabled = true;
            }
        }
        
        function addToConversation(speaker, original, translated) {
            const timestamp = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).replace(',', '');
            
            conversationHistory.push({
                speaker: speaker.toLowerCase(),
                original: original,
                translated: translated,
                timestamp: `[${timestamp}]`
            });
            
            updateConversationUI();
        }
        
        function playAudio(audioData) {
            try {
                audioPlayer.src = 'data:audio/mp3;base64,' + audioData;
                audioPlayer.play().catch(e => {
                    console.error('Audio playback error:', e);
                    showAlert('Audio playback failed. Please check your speakers.', 'warning');
                });
            } catch (e) {
                console.error('Error handling audio data:', e);
                showAlert('Error processing audio', 'danger');
            }
        }
        
        async function sendTranslationRequest(speaker, targetLang) {
            const doctorBtn = document.getElementById('doctor-btn');
            const patientBtn = document.getElementById('patient-btn');
            const doctorRecording = document.getElementById('doctor-recording');
            const patientRecording = document.getElementById('patient-recording');
            
            const button = speaker === 'doctor' ? doctorBtn : patientBtn;
            const recordingIndicator = speaker === 'doctor' ? doctorRecording : patientRecording;
            const originalLabel = speaker === 'doctor' ? 'Doctor Speaking' : 'Patient Speaking';
            
            // Update UI to show recording state
            button.querySelector('.btn-label').textContent = "Listening...";
            recordingIndicator.style.display = 'block';
            
            try {
                const response = await fetch('/translator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `action=${speaker}&doctor_lang=${encodeURIComponent(document.getElementById('doctor-lang-input').value)}&patient_lang=${encodeURIComponent(document.getElementById('patient-lang-input').value)}`
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.message) {
                    // Parse the response message
                    const lines = data.message.split('\n');
                    let originalText = '';
                    let translatedText = '';
                    
                    for (const line of lines) {
                        if (line.includes('said:')) {
                            originalText = line.split('said:')[1].trim();
                        } else if (line.includes('Translated:')) {
                            translatedText = line.split('Translated:')[1].trim();
                        }
                    }
                    
                    if (originalText && translatedText) {
                        addToConversation(speaker, originalText, translatedText);
                    } else {
                        showAlert('Received incomplete translation data', 'warning');
                    }
                }
                
                if (data.audio_data) {
                    playAudio(data.audio_data);
                }
                
            } catch (error) {
                console.error('Error during translation request:', error);
                showAlert('Translation request failed: ' + error.message, 'danger');
            } finally {
                // Reset UI
                button.querySelector('.btn-label').textContent = originalLabel;
                recordingIndicator.style.display = 'none';
            }
        }
        
        // Event listeners
        document.getElementById('doctor-btn').addEventListener('click', () => {
            if (isProcessing) return;
            isProcessing = true;
            sendTranslationRequest('doctor', document.getElementById('patient-lang-input').value)
                .finally(() => { isProcessing = false; });
        });
        
        document.getElementById('patient-btn').addEventListener('click', () => {
            if (isProcessing) return;
            isProcessing = true;
            sendTranslationRequest('patient', document.getElementById('doctor-lang-input').value)
                .finally(() => { isProcessing = false; });
        });
        
        document.getElementById('clear-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/translator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: 'action=clear'
                });
                
                if (response.ok) {
                    conversationHistory = [];
                    updateConversationUI();
                    showAlert('Conversation cleared', 'success');
                } else {
                    throw new Error('Failed to clear conversation');
                }
            } catch (error) {
                console.error('Error clearing conversation:', error);
                showAlert('Failed to clear conversation', 'danger');
            }
        });
        
        document.getElementById('download-btn').addEventListener('click', () => {
            if (conversationHistory.length === 0) return;
            
            // Format conversation history for download
            let textContent = "Doctor-Patient Conversation History\n\n";
            textContent += `Doctor's Language: ${document.getElementById('doctor-lang-input').value}\n`;
            textContent += `Patient's Language: ${document.getElementById('patient-lang-input').value}\n\n`;
            
            conversationHistory.forEach(entry => {
                const speaker = entry.speaker === 'doctor' ? 'Doctor' : 'Patient';
                textContent += `${entry.timestamp} ${speaker} said: ${entry.original}\n`;
                if (entry.translated) {
                    textContent += `${entry.timestamp} Translated: ${entry.translated}\n`;
                }
                textContent += '\n';
            });
            
            // Create download link
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'conversation_history.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Load initial conversation history if any
        async function loadInitialHistory() {
            try {
                const response = await fetch('/translator');
                if (response.ok) {
                    const data = await response.json();
                    if (data.conversation) {
                        conversationHistory = data.conversation;
                        updateConversationUI();
                    }
                }
            } catch (error) {
                console.error('Error loading initial history:', error);
            }
        }
        
        loadInitialHistory();
    });
    </script>
</body>
</html>
